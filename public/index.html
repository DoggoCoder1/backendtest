<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Token Login Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <!-- Removed Tailwind CSS link -->
  <!-- Removed custom styles.css link -->
</head>
<body>
  <div id="authSection">
    <h2>Register</h2>
    <input id="registerUsername" placeholder="Username" type="text">
    <input id="registerPassword" placeholder="Password" type="password">
    <button onclick="registerUser()">Register</button>
    <p id="registerMessage"></p>

    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username" type="text">
    <input id="loginPassword" placeholder="Password" type="password">
    <button onclick="loginUser()">Login</button>
    <p id="loginMessage"></p>
  </div>

  <div id="chatSection" style="display:none;">
    <p>Logged in as: <strong id="loggedInUsername"></strong></p>
    <div>
      <input id="messageInput" placeholder="Type a message">
      <button onclick="sendMessage()">Send</button>
      <button onclick="logout()">Logout</button>
    </div>
    <ul id="chatBox"></ul>
    <!-- Audio element for notification -->
    <!-- IMPORTANT: Ensure 'notification.wav' is placed in your project's 'public' directory -->
    <audio id="notificationSound" src="/notification.wav" preload="auto"></audio>
  </div>

<script>
  // Retrieve token and username from localStorage on page load
  let token = localStorage.getItem('chatToken');
  let currentUsername = localStorage.getItem('chatUsername');
  // Removed currentRole as styling is no longer desired

  // Get references to DOM elements
  const chatBox = document.getElementById('chatBox');
  const authSection = document.getElementById('authSection');
  const chatSection = document.getElementById('chatSection');
  const loggedInUsernameDisplay = document.getElementById('loggedInUsername');
  const registerMessage = document.getElementById('registerMessage');
  const loginMessage = document.getElementById('loginMessage');
  const notificationSound = document.getElementById('notificationSound'); // Get audio element

  // Log the audio source to console for debugging
  console.log("Notification sound source:", notificationSound.src);


  // Function to update the UI based on authentication status
  function updateUI() {
    if (token && currentUsername) {
      authSection.style.display = 'none';
      chatSection.style.display = 'block';
      loggedInUsernameDisplay.textContent = currentUsername;

      // Removed admin styling logic from logged-in username

      fetchMessages(); // Fetch messages immediately after login/UI update
      // Start polling for new messages only if not already started
      if (!window.messageFetchInterval) {
        window.messageFetchInterval = setInterval(fetchMessages, 1000);
      }
    } else {
      authSection.style.display = 'block';
      chatSection.style.display = 'none';
      // Stop polling for messages if logged out
      if (window.messageFetchInterval) {
        clearInterval(window.messageFetchInterval);
        window.messageFetchInterval = null;
      }
      chatBox.innerHTML = ''; // Clear chat messages
    }
  }

  // --- User Registration Function ---
  async function registerUser() {
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;

    if (!username || !password) {
      registerMessage.textContent = 'Please enter both username and password.';
      registerMessage.style.color = 'red';
      return;
    }

    try {
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (res.ok) {
        registerMessage.textContent = data.message;
        registerMessage.style.color = 'green';
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerPassword').value = '';
      } else {
        registerMessage.textContent = data.error || 'Registration failed.';
        registerMessage.style.color = 'red';
      }
    } catch (error) {
      console.error('Registration error:', error);
      registerMessage.textContent = 'An unexpected error occurred during registration.';
      registerMessage.style.color = 'red';
    }
  }

  // --- User Login Function ---
  async function loginUser() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
      loginMessage.textContent = 'Please enter both username and password.';
      loginMessage.style.color = 'red';
      return;
    }

    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (res.ok) {
        token = data.token;
        currentUsername = data.username;
        // Removed currentRole storage
        localStorage.setItem('chatToken', token);
        localStorage.setItem('chatUsername', currentUsername);
        // Removed chatRole from localStorage
        loginMessage.textContent = 'Login successful!';
        loginMessage.style.color = 'green';
        document.getElementById('loginPassword').value = '';
        updateUI();
      } else {
        loginMessage.textContent = data.error || 'Login failed. Please check your credentials.';
        loginMessage.style.color = 'red';
      }
    } catch (error) {
      console.error('Login error:', error);
      loginMessage.textContent = 'An unexpected error occurred during login.';
      loginMessage.style.color = 'red';
    }
  }

  // --- User Logout Function ---
  function logout() {
    token = null;
    currentUsername = null;
    // Removed currentRole clearing
    localStorage.removeItem('chatToken');
    localStorage.removeItem('chatUsername');
    // Removed chatRole from localStorage
    updateUI();
    loginMessage.textContent = '';
    registerMessage.textContent = '';
  }

  // --- Fetch Messages Function ---
  async function fetchMessages() {
    if (!token) {
      updateUI();
      return;
    }

    try {
      const res = await fetch('/api/chat', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.ok) {
        const data = await res.json();
        // Check if there are new messages before updating and playing sound
        const currentMessageCount = chatBox.children.length;
        const newMessageCount = data.messages.length;

        chatBox.innerHTML = ''; // Clear existing messages
        data.messages.reverse().forEach(msg => {
          const li = document.createElement('li');
          // Removed admin role check and styling logic for messages
          li.textContent = `[${msg.username}]: ${msg.content}`;
          chatBox.appendChild(li);
        });
        chatBox.scrollTop = chatBox.scrollHeight;

        // Play notification sound only if new messages have arrived
        if (newMessageCount > currentMessageCount) {
          notificationSound.play().catch(e => console.error("Error playing sound:", e));
        }

      } else if (res.status === 401 || res.status === 403) {
        console.warn('Token invalid or expired. Logging out.');
        logout();
        alert('Your session expired or is invalid. Please log in again.');
      } else {
        console.error('Failed to fetch messages:', res.status, res.statusText);
      }
    } catch (error) {
      console.error('Error fetching messages:', error);
    }
  }

  // --- Send Message Function ---
  async function sendMessage() {
    if (!token) {
      alert('Please log in to send messages.');
      return;
    }

    const content = document.getElementById('messageInput').value.trim();
    if (!content) {
      return;
    }

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ content })
      });

      if (res.ok) {
        document.getElementById('messageInput').value = '';
        fetchMessages();
      } else if (res.status === 401 || res.status === 403) {
        console.warn('Token invalid or expired. Logging out.');
        logout();
        alert('Your session expired. Please log in again.');
      } else {
        const errorData = await res.json();
        alert(`Failed to send message: ${errorData.error || res.statusText}`);
      }
    } catch (error) {
      console.error('Error sending message:', error);
      alert('An error occurred while sending the message.');
    }
  }

  // Initial UI update when the page loads
  updateUI();

  // Add event listeners for Enter key
  document.getElementById('messageInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      sendMessage();
    }
  });

  document.getElementById('loginPassword').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      loginUser();
    }
  });

  document.getElementById('registerPassword').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      registerUser();
    }
  });
</script>
</body>
</html>
